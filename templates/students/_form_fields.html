{% load form_tags %}
{% load permission_tags %}
{# Shared grouped fields for StudentForm using Bootstrap grid #}

{# Identity #}
{% can_read user 'identity' as can_read_identity %}
{% if can_read_identity %}
<div class="card mb-4">
  <div class="card-header">Identity</div>
  <div class="card-body">
    <div class="row g-3">
      {% can_write user 'identity' form.instance as can_write_identity %}
      <div class="col-md-4">{% if can_write_identity %}{% render_field form.legal_first_name %}{% else %}{% render_field form.legal_first_name readonly=True %}{% endif %}</div>
      <div class="col-md-4">{% if can_write_identity %}{% render_field form.first_name %}{% else %}{% render_field form.first_name readonly=True %}{% endif %}</div>
      <div class="col-md-4">{% if can_write_identity %}{% render_field form.last_name %}{% else %}{% render_field form.last_name readonly=True %}{% endif %}</div>
      <div class="col-md-4">{% if can_write_identity %}{% render_field form.pronouns %}{% else %}{% render_field form.pronouns readonly=True %}{% endif %}</div>
      <div class="col-md-4">{% if can_write_identity %}{% render_field form.date_of_birth %}{% else %}{% render_field form.date_of_birth readonly=True %}{% endif %}</div>
      <div class="col-md-4">{% if can_write_identity %}{% render_field form.photo %}{% else %}{% render_field form.photo readonly=True %}{% endif %}</div>
    </div>
  </div>
</div>
{% endif %}

{% if form.instance and form.instance.pk and 'background-checks' in program_feature_keys %}
{% can_read user 'background_checks' as can_read_bg %}
{% if can_read_bg %}
<div class="card mb-4">
  <div class="card-header">Background Checks</div>
  <div class="card-body">
      <div>The student needs background checks to participate in the following programs:</div>
      {% if form.instance.programs.all %}
          <ul class="mb-0">
              {% for prog in form.instance.programs.all %}
                  {% requires_bg form.instance prog as needs_bg %}
                  <li>{{ prog.year }} {{ prog.name }}: <span class="badge {% if needs_bg %}bg-warning text-dark{% else %}bg-secondary{% endif %}">{{ needs_bg|yesno:"Yes,No" }}</span></li>
              {% empty %}
                  <li class="text-muted">Not enrolled in any programs.</li>
              {% endfor %}
          </ul>
      {% else %}
          <div class="text-muted">Not enrolled in any programs.</div>
      {% endif %}
      <div class="form-text">This is informational; the requirement is calculated from date of birth and program dates.</div>
    <hr/>
      <div class="row g-3">
          {% can_write user 'background_checks' form.instance as can_write_bg %}
          <div class="col-md-4">{% if can_write_bg %}{% render_field form.has_passed_clearances %}{% else %}{% render_field form.has_passed_clearances disabled=True %}{% endif %}</div>
          <div class="col-md-4">{% if can_write_bg %}{% render_field form.clearances_expiration_date %}{% else %}{% render_field form.clearances_expiration_date readonly=True %}{% endif %}</div>
      </div>
  </div>
</div>
{% endif %}
{% endif %}

{# Contact & Address #}
{% can_read user 'contact_address' as can_read_contact %}
{% if can_read_contact %}
<div class="card mb-4">
  <div class="card-header">Contact & Address</div>
  <div class="card-body">
    <div class="row g-3">
      {% can_write user 'contact_address' form.instance as can_write_contact %}
      <div class="col-md-6">{% if can_write_contact %}{% render_field form.personal_email %}{% else %}{% render_field form.personal_email readonly=True %}{% endif %}</div>
      <div class="col-md-6">{% if can_write_contact %}{% render_field form.cell_phone_number %}{% else %}{% render_field form.cell_phone_number readonly=True %}{% endif %}</div>
      <div class="col-md-6">{% if can_write_contact %}{% render_field form.address %}{% else %}{% render_field form.address readonly=True %}{% endif %}</div>
      <div class="col-md-3">{% if can_write_contact %}{% render_field form.city %}{% else %}{% render_field form.city readonly=True %}{% endif %}</div>
      <div class="col-md-3">{% if can_write_contact %}{% render_field form.state %}{% else %}{% render_field form.state readonly=True %}{% endif %}</div>
      <div class="col-md-3">{% if can_write_contact %}{% render_field form.zip_code %}{% else %}{% render_field form.zip_code readonly=True %}{% endif %}</div>
    </div>
</div>
</div>
{% endif %}

{# Health & Medical #}
{% can_read user 'health_medical' as can_read_medical %}
{% if can_read_medical %}
<div class="card mb-4">
  <div class="card-header">Health &amp; Medical</div>
  <div class="card-body">
    <div class="row g-3">
      {% can_write user 'health_medical' form.instance as can_write_medical %}
      <div class="col-md-6">{% if can_write_medical %}{% render_field form.allergies %}{% else %}{% render_field form.allergies readonly=True %}{% endif %}</div>
      <div class="col-md-6">{% if can_write_medical %}{% render_field form.dietary_restrictions %}{% else %}{% render_field form.dietary_restrictions readonly=True %}{% endif %}</div>
      <div class="col-md-12">{% if can_write_medical %}{% render_field form.medical_notes %}{% else %}{% render_field form.medical_notes readonly=True %}{% endif %}</div>
    </div>
  </div>
</div>
{% endif %}

{# School #}
{% can_read user 'school' as can_read_school %}
{% if can_read_school %}
<div class="card mb-4">
  <div class="card-header">School</div>
  <div class="card-body">
    <div class="row g-3">
      {% can_write user 'school' form.instance as can_write_school %}
      <div class="col-md-6">{% if can_write_school %}{% render_field form.school %}{% else %}{% render_field form.school disabled=True %}{% endif %}</div>
      <div class="col-md-3">{% if can_write_school %}{% render_field form.grade_selector %}{% else %}{% render_field form.grade_selector disabled=True %}{% endif %}</div>
      <div class="col-md-3">{% if can_write_school %}{% render_field form.graduation_year %}{% else %}{% render_field form.graduation_year readonly=True %}{% endif %}</div>
      <div class="col-md-3">{% if can_write_school %}{% render_field form.tshirt_size %}{% else %}{% render_field form.tshirt_size readonly=True %}{% endif %}</div>
    </div>
  </div>
</div>
{% endif %}

{# Andrew ID (CMU) #}
{% can_read user 'cmu_andrew' as can_read_cmu %}
{% if can_read_cmu and 'cmu-andrew' in program_feature_keys %}
<div class="card mb-4">
  <div class="card-header">CMU Andrew ID</div>
  <div class="card-body">
    <div class="row g-3">
      {% can_write user 'cmu_andrew' form.instance as can_write_cmu %}
      <div class="col-md-4">{% if can_write_cmu %}{% render_field form.andrew_id %}{% else %}{% render_field form.andrew_id readonly=True %}{% endif %}</div>
      <div class="col-md-6">{% if can_write_cmu %}{% render_field form.andrew_email %}{% else %}{% render_field form.andrew_email readonly=True %}{% endif %}</div>
    </div>
  </div>
</div>
{% endif %}

{# Demographics & Preferences #}
{% can_read user 'other_details' as can_read_other %}
{% if can_read_other %}
<div class="card mb-4">
  <div class="card-header">Other Details</div>
  <div class="card-body">
    <div class="row g-3">
      {% can_write user 'other_details' form.instance as can_write_other %}
      <div class="col-md-6">{% if can_write_other %}{% render_field form.race_ethnicities %}{% else %}{% render_field form.race_ethnicities disabled=True %}{% endif %}</div>
      <div class="col-md-3">{% if can_write_other %}{% render_field form.seen_once %}{% else %}{% render_field form.seen_once disabled=True %}{% endif %}</div>
      {% user_role user as role %}
      {% if role == 'LeadMentor' %}
        <div class="col-md-3">{% render_field form.active %}</div>
      {% else %}
        <div class="col-md-3">
          <label class="form-label">Active</label>
          <p class="form-control-plaintext">
            <span class="badge {% if form.instance.active %}bg-success{% else %}bg-secondary{% endif %}">
              {{ form.instance.active|yesno:"Yes,No" }}
            </span>
          </p>
          {% if form.active.errors %}
            <div class="invalid-feedback d-block">{{ form.active.errors|join:", " }}</div>
          {% endif %}
          <input type="hidden" name="active" value="{% if form.instance.active %}on{% endif %}">
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

{# Discord #}
{% can_read user 'discord' as can_read_discord %}
{% if can_read_discord and 'discord' in program_feature_keys %}
<div class="card mb-4">
  <div class="card-header">Discord</div>
  <div class="card-body">
    <div class="row g-3">
      {% can_write user 'discord' form.instance as can_write_discord %}
      <div class="col-md-3">{% if can_write_discord %}{% render_field form.on_discord %}{% else %}{% render_field form.on_discord disabled=True %}{% endif %}</div>
      <div class="col-md-9">{% if can_write_discord %}{% render_field form.discord_handle %}{% else %}{% render_field form.discord_handle readonly=True %}{% endif %}</div>
    </div>
  </div>
</div>
{% endif %}

{# FIRST Website #}
{% can_read user 'first_website' as can_read_first %}
{% if can_read_first %}
<div class="card mb-4">
  <div class="card-header">FIRST Website</div>
  <div class="card-body">
    <div class="row g-3">
      {% can_write user 'first_website' form.instance as can_write_first %}
      <div class="col-md-4">{% if can_write_first %}{% render_field form.first_has_account %}{% else %}{% render_field form.first_has_account disabled=True %}{% endif %}</div>
      <div class="col-md-4">{% if can_write_first %}{% render_field form.first_attached_to_parent_account %}{% else %}{% render_field form.first_attached_to_parent_account disabled=True %}{% endif %}</div>
      <div class="col-md-4">{% if can_write_first %}{% render_field form.first_signed_cr %}{% else %}{% render_field form.first_signed_cr disabled=True %}{% endif %}</div>
      <div class="col-md-12">{% if can_write_first %}{% render_field form.first_registered_teams %}{% else %}{% render_field form.first_registered_teams readonly=True %}{% endif %}</div>
    </div>
  </div>
</div>
{% endif %}

{# Parents / Contacts #}
{% can_read user 'parents_emergency' as can_read_parents %}
{% if can_read_parents %}
<div class="card mb-4">
  <div class="card-header">Parents / Emergency Contacts</div>
  <div class="card-body">
    {% can_write user 'parents_emergency' form.instance as can_write_parents %}
    {# Keep original Django fields hidden so we can synchronize values before submit #}
    <div class="d-none">
      <div class="col-md-6">{% if can_write_parents %}{% render_field form.primary_contact %}{% else %}{% render_field form.primary_contact disabled=True %}{% endif %}</div>
      <div class="col-md-6">{% if can_write_parents %}{% render_field form.secondary_contact %}{% else %}{% render_field form.secondary_contact disabled=True %}{% endif %}</div>
      <div class="col-12">{% if can_write_parents %}{% render_field form.parents %}{% else %}{% render_field form.parents disabled=True %}{% endif %}</div>
    </div>

    <div class="mb-3">
      <label class="form-label">Find a parent/guardian</label>
      <div class="d-flex gap-2">
        <select id="parent-picker" class="form-select" style="max-width:480px" {% if not can_write_parents %}disabled{% endif %}>
          <option value="">— Select a parent —</option>
          {% for val,label in form.parents.field.choices %}
            {% if val %}<option value="{{ val }}">{{ label }}</option>{% endif %}
          {% endfor %}
        </select>
        <button type="button" id="add-parent-btn" class="btn btn-outline-primary" {% if not can_write_parents %}disabled{% endif %}>Add</button>
      </div>
    </div>

    <div id="selected-parents">
      <div class="mb-2 text-muted">Selected parents / contacts:</div>
      <div id="parent-list" class="list-group mb-2">
        {# Pre-populate from existing selection #}
        {% with sel_parents=form.instance.all_parents %}
          {% for p in sel_parents %}
            <div class="list-group-item d-flex align-items-center justify-content-between" data-parent-id="{{ p.id }}">
              <div class="me-3">
                <div class="fw-semibold">{{ p }}</div>
                <div class="small text-muted">{{ p.email }}{% if p.phone_number %} • {{ p.phone_number }}{% endif %}</div>
              </div>
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <div class="d-flex align-items-center gap-1">
                  <label class="form-label mb-0 small">Relationship</label>
                  <select class="form-select form-select-sm parent-rel" data-parent-id="{{ p.id }}" {% if not can_write_parents %}disabled{% endif %}>
                    {% for k,v in RELATIONSHIP_CHOICES %}
                      <option value="{{ k }}" {% if p.relationship_to_student == k %}selected{% endif %}>{{ v }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-check">
                  <input class="form-check-input parent-primary" type="radio" name="primary_choice" value="{{ p.id }}" {% if object.primary_contact_id == p.id %}checked{% endif %} {% if not can_write_parents %}disabled{% endif %}>
                  <label class="form-check-label">Primary</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input parent-secondary" type="radio" name="secondary_choice" value="{{ p.id }}" {% if object.secondary_contact_id == p.id %}checked{% endif %} {% if not can_write_parents %}disabled{% endif %}>
                  <label class="form-check-label">Secondary</label>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger remove-parent" {% if not can_write_parents %}disabled{% endif %}>Remove</button>
              </div>
            </div>
          {% endfor %}
        {% endwith %}
      </div>
      {% if can_write_parents %}
      <div class="alert alert-secondary">
        Can't find a parent? Quickly add one:
        <a class="alert-link" href="{% url 'parent_create' %}?next={{ request.path }}">Add Parent</a>
      </div>
      {% endif %}
    </div>

    <script>
      (function(){
        // Relationship choices from server for creating new items dynamically
        var REL_CHOICES = [
          {% for k,v in RELATIONSHIP_CHOICES %}["{{ k }}","{{ v }}"],{% endfor %}
        ];
        var CAN_WRITE = {% if can_write_parents %}true{% else %}false{% endif %};
        function ensureHiddenFieldSync(){
          if(!CAN_WRITE) return; // Don't sync if we can't write
          // parents multi-select
          var parentsSelect = document.querySelector('select[name="parents"]');
          var items = document.querySelectorAll('#parent-list .list-group-item');
          // Clear all selections first
          if(parentsSelect){
            for (var i=0;i<parentsSelect.options.length;i++){ parentsSelect.options[i].selected = false; }
          }
          items.forEach(function(it){
            var pid = it.getAttribute('data-parent-id');
            if(parentsSelect){
              for (var i=0;i<parentsSelect.options.length;i++){
                if(parentsSelect.options[i].value == pid){ parentsSelect.options[i].selected = true; break; }
              }
            }
          });
          // primary/secondary
          var primary = document.querySelector('input[name="primary_choice"]:checked');
          var secondary = document.querySelector('input[name="secondary_choice"]:checked');
          var primarySel = document.querySelector('select[name="primary_contact"]');
          var secondarySel = document.querySelector('select[name="secondary_contact"]');
          if(primarySel){ primarySel.value = primary ? primary.value : ''; }
          if(secondarySel){ secondarySel.value = secondary ? secondary.value : ''; }
          // relationship hidden inputs
          // remove existing
          document.querySelectorAll('input[name^="parent_rel_"]').forEach(function(n){ n.remove(); });
          items.forEach(function(it){
            var pid = it.getAttribute('data-parent-id');
            var sel = it.querySelector('select.parent-rel');
            if(sel){
              var input = document.createElement('input');
              input.type = 'hidden';
              input.name = 'parent_rel_' + pid;
              input.value = sel.value;
              it.closest('form').appendChild(input);
            }
          });
        }
        function addParent(pid, label){
          if(!CAN_WRITE) return;
          if(!pid) return;
          // avoid duplicates
          if(document.querySelector('#parent-list .list-group-item[data-parent-id="'+pid+'"]')) return;
          var item = document.createElement('div');
          item.className = 'list-group-item d-flex align-items-center justify-content-between';
          item.setAttribute('data-parent-id', pid);
          var nameHtml = '<div class="fw-semibold">'+label+'</div>';
          var detailHtml = '';
          item.innerHTML = '<div class="me-3">'+nameHtml+'</div>'+
            '<div class="d-flex align-items-center gap-2 flex-wrap">'+
            '  <div class="d-flex align-items-center gap-1">'+
            '    <label class="form-label mb-0 small">Relationship</label>'+
            '    <select class="form-select form-select-sm parent-rel" data-parent-id="'+pid+'">'+
            REL_CHOICES.map(function(p){ return '<option value="'+p[0]+'">'+p[1]+'</option>'; }).join('')+
            '    </select>'+
            '  </div>'+
            '  <div class="form-check">'+
            '    <input class="form-check-input parent-primary" type="radio" name="primary_choice" value="'+pid+'">'+
            '    <label class="form-check-label">Primary</label>'+
            '  </div>'+
            '  <div class="form-check">'+
            '    <input class="form-check-input parent-secondary" type="radio" name="secondary_choice" value="'+pid+'">'+
            '    <label class="form-check-label">Secondary</label>'+
            '  </div>'+
            '  <button type="button" class="btn btn-sm btn-outline-danger remove-parent">Remove</button>'+
            '</div>';
          document.getElementById('parent-list').appendChild(item);
          ensureHiddenFieldSync();
        }
        function hook(){
          if(!CAN_WRITE) return;
          var addBtn = document.getElementById('add-parent-btn');
          var picker = document.getElementById('parent-picker');
          var parentChoices = {};
          if(picker){
            // build id->label map
            Array.prototype.forEach.call(picker.options, function(opt){ if(opt.value){ parentChoices[opt.value] = opt.text; } });
          }
          if(addBtn){
            addBtn.addEventListener('click', function(){
              var pid = picker.value;
              if(pid){ addParent(pid, parentChoices[pid] || ('Parent #'+pid)); }
            });
          }
          document.getElementById('parent-list').addEventListener('click', function(ev){
            if(ev.target && ev.target.classList.contains('remove-parent')){
              var item = ev.target.closest('.list-group-item');
              if(item){ item.remove(); ensureHiddenFieldSync(); }
            }
          });
          document.getElementById('parent-list').addEventListener('change', function(ev){
            if(ev.target && (ev.target.classList.contains('parent-rel') || ev.target.classList.contains('parent-primary') || ev.target.classList.contains('parent-secondary'))){
              ensureHiddenFieldSync();
            }
          });
          // Initial sync (for pre-rendered existing parents)
          ensureHiddenFieldSync();
          // On form submit, final sync
          var form = document.querySelector('form');
          if(form){ form.addEventListener('submit', ensureHiddenFieldSync); }
        }
        if(document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', hook);
        } else { hook(); }
      })();
    </script>
  </div>
</div>
{% endif %}
