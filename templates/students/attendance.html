{% extends 'base.html' %}
{% load static %}
{% block title %}Attendance — {{ student.first_name|default:student.legal_first_name }} {{ student.last_name }}{% endblock %}

{% block content %}
<div class="container my-4">
  <h1>Attendance for {{ student.first_name|default:student.legal_first_name }} {{ student.last_name }}</h1>

  {% if error %}
  <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  <div class="row g-4">
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">Add Session</div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="create" />
            <div class="mb-3">
              <label for="program_id" class="form-label">Program</label>
              <select class="form-select" id="program_id" name="program_id" required>
                <option value="">Select program…</option>
                {% for p in enrolled_programs %}
                <option value="{{ p.id }}">{{ p.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="check_in" class="form-label">Check-in</label>
              <input type="datetime-local" class="form-control" id="check_in" name="check_in" required />
            </div>
            <div class="mb-3">
              <label for="check_out" class="form-label">Check-out (optional)</label>
              <input type="datetime-local" class="form-control" id="check_out" name="check_out" />
            </div>
            <button type="submit" class="btn btn-primary">Add Session</button>
          </form>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-header">This week</div>
        <div class="card-body">
          <p class="mb-1"><strong>Week:</strong> {{ week_start|date:'M d, Y' }} – {{ week_end|date:'M d, Y' }}</p>
          <p class="mb-1"><strong>Total hours:</strong> {{ weekly_hours }}</p>
          <p class="mb-0 text-muted"><strong>Average hours/day:</strong> {{ weekly_avg_hours }}</p>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-header">Since program start</div>
        <div class="card-body">
          {% if overall_start_date %}
            <p class="mb-1"><strong>Program{% if selected_program %} ({{ selected_program.name }}){% endif %} start:</strong> {{ overall_start_date|date:'M d, Y' }}</p>
            <p class="mb-1"><strong>Total hours:</strong> {{ overall_total_hours }}</p>
            <p class="mb-0 text-muted"><strong>Average hours/week:</strong> {{ overall_avg_hours_per_week }}</p>
          {% else %}
            <p class="mb-0 text-muted">No start date found. Add a Program start date or attendance to compute totals.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card">
        <div class="card-header">Sessions (latest first)</div>
        <div class="table-responsive">
          <table class="table table-striped mb-0">
            <thead>
              <tr>
                <th>Program</th>
                <th>Check-in</th>
                <th>Check-out</th>
                <th>Minutes</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
            {% for s in sessions %}
              <tr>
                <td>{{ s.program.name }}</td>
                <td>{{ s.check_in|date:'Y-m-d H:i' }}</td>
                <td>{% if s.check_out %}{{ s.check_out|date:'Y-m-d H:i' }}{% else %}<span class="badge bg-warning text-dark">Open</span>{% endif %}</td>
                <td>{{ s.duration_minutes }}</td>
                <td class="text-nowrap">
                  <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#edit{{ s.id }}">Edit</button>
                  <form method="post" class="d-inline" onsubmit="return confirm('Delete this session?');">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete" />
                    <input type="hidden" name="session_id" value="{{ s.id }}" />
                    <button class="btn btn-sm btn-outline-danger">Delete</button>
                  </form>
                </td>
              </tr>
              <tr class="collapse" id="edit{{ s.id }}">
                <td colspan="5">
                  <form method="post" class="row g-3 p-3">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update" />
                    <input type="hidden" name="session_id" value="{{ s.id }}" />
                    <div class="col-md-5">
                      <label class="form-label">Check-in</label>
                      <input type="datetime-local" class="form-control" name="check_in" value="{{ s.check_in|date:'Y-m-d\TH:i' }}" />
                    </div>
                    <div class="col-md-5">
                      <label class="form-label">Check-out</label>
                      <input type="datetime-local" class="form-control" name="check_out" value="{% if s.check_out %}{{ s.check_out|date:'Y-m-d\TH:i' }}{% endif %}" />
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                      <button class="btn btn-sm btn-primary">Save</button>
                    </div>
                  </form>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="5" class="text-center text-muted">No attendance yet.</td></tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
