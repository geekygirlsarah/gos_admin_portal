{% extends 'base.html' %}
{% load static %}
{% block title %}Balance Sheet — {{ student.first_name|default:student.legal_first_name }} {{ student.last_name }} —
    {{ program.name }}{% endblock %}
{% block extra_head %}
    <style>
        /* Hide the site navbar on the receipt page (screen and print) */
        nav, .navbar {
            display: none !important;
        }

        @media print {
            .no-print, .alert {
                display: none !important;
            }

            main.container {
                padding: 0 !important;
            }

            .card {
                border: none;
            }
        }

        .org-header {
            margin-bottom: .75rem;
        }

        .receipt-header {
            border-bottom: 2px solid #000;
            margin-bottom: 1rem;
            padding-bottom: .5rem;
        }
    </style>
{% endblock %}
{% block content %}
    <div class="row">
        <div class="col-lg-10 col-xl-8 text-end">
            <button class="btn btn-primary no-print " onclick="window.print()">Print</button>
        </div>
    </div>

    <div class="row">
    <div class="col-lg-10 col-xl-8 mb-3">
        <div class="org-header text-end">
            <img src="{% static 'img/cmu-text-logo.png' %}" alt="Carnegie Mellon University logo" class="img-fluid"
                 style="max-width: 250px;">
            <div class="fw-bold">Girls of Steel Robotics</div>
            <div>Carnegie Mellon University</div>
            <div class="mb-2">EIN: 25-0969449</div>
            <div>5000 Forbes Ave</div>
            <div class="mb-2">Pittsburgh, PA 15213-3890</div>
            <div>cmu.edu</div>
        </div>

        <div class="d-flex justify-content-between align-items-start receipt-header">
            <div>
                <h1 class="h4 mb-1">Program Registration Balance Sheet</h1>
                <div class="text-muted small">Date issued: {% timezone "America/New_York" %}{% now 'm/d/Y h:i A' %}{% endtimezone %}</div>
            </div>
        </div>

        <div class="mb-3">
            <div><span class="fw-semibold">Program:</span> {{ program.name }} -- {{ program.year }}</div>
            <div class="mb-2"><span
                    class="fw-semibold">Participant's name:</span> {{ student.legal_first_name|default:student.first_name }} {{ student.last_name }}{% if student.date_of_birth %} <span class="text-muted small js-age" data-dob="{{ student.date_of_birth|date:'Y-m-d' }}">(Age: --)</span>{% endif %}
            </div>
            <div><span class="fw-semibold">Parent(s)/Guardian(s) names:</span>
                {% if student.primary_contact or student.secondary_contact %}
                    {% if student.primary_contact %}{{ student.primary_contact }}{% endif %}
                    {% if student.secondary_contact %}
                        {% if student.primary_contact %}, {% endif %}{{ student.secondary_contact }}
                    {% endif %}
                {% else %}
                    <span class="text-muted">Not provided</span>
                {% endif %}
            </div>
            <div class="mb-2"><span class="fw-semibold">Address:</span>
                {% if student.primary_contact or student.secondary_contact %}
                        {{ student.address }}, {{ student.city }} {{ student.state }} {{ student.zip_code }}
                {% else %}
                    <span class="text-muted">Not provided</span>
                {% endif %}
            </div>

            {% if entries %}
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead>
                        <tr>
                            <th style="width: 120px;">Date</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th class="text-end" style="width: 160px;">Amount</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for e in entries %}
                            <tr>
                                <td>{{ e.date }}</td>
                                <td>{{ e.type }}</td>
                                <td>{{ e.name }}</td>
                                <td class="text-end">${{ e.amount|floatformat:2 }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                        <tfoot>
                        <tr>
                            <th colspan="3" class="text-end">Total Fees</th>
                            <th class="text-end">${{ total_fees|floatformat:2 }}</th>
                        </tr>
                        <tr>
                            <th colspan="3" class="text-end">Sliding Scale</th>
                            <th class="text-end">-${{ total_sliding|floatformat:2 }}</th>
                        </tr>
                        <tr>
                            <th colspan="3" class="text-end">Payments</th>
                            <th class="text-end">-${{ total_payments|floatformat:2 }}</th>
                        </tr>
                        <tr>
                            <th colspan="3" class="text-end">Balance Due</th>
                            <th class="text-end">${{ balance|floatformat:2 }}</th>
                        </tr>
                        </tfoot>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">No financial entries yet for this student and program.</div>
            {% endif %}

            <div class=""><span class="fw-semibold">Program Contacts:</span> Elizabeth Kysel, Sarah Withee</div>
            <div class=""><span class="fw-semibold">Email address:</span> leads@girlsofsteelrobotics.org</div>


            <div class="mt-4 small text-muted">
                Thank you for your support! Please keep this document for your records.
            </div>

        </div>
    </div>
    <script>
      (function() {
        function calcAge(dobStr) {
          var dob = new Date(dobStr + 'T00:00:00');
          if (isNaN(dob.getTime())) return null;
          var today = new Date();
          var age = today.getFullYear() - dob.getFullYear();
          var m = today.getMonth() - dob.getMonth();
          if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
            age--;
          }
          return age;
        }
        var nodes = document.querySelectorAll('.js-age[data-dob]');
        nodes.forEach(function(n) {
          var dob = n.getAttribute('data-dob');
          var age = calcAge(dob);
          if (age !== null && age >= 0) {
            n.textContent = '(Age: ' + age + ')';
          } else {
            n.textContent = '';
          }
        });
      })();
    </script>
{% endblock %}
