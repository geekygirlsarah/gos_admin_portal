{% extends 'base.html' %}
{% load permission_tags %}
{% block title %}Balance — {{ student.first_name|default:student.legal_first_name }} {{ student.last_name }} — {{ program.name }}{% endblock %}
{% block nav_programs_active %} active{% endblock %}
{% block content %}
  <div class="row mb-3">
    <div class="col">
      <a class="link-secondary" href="{% url 'program_detail' program.id %}">← Back to {{ program.name }}</a>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-10 col-xl-8">
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="h4 mb-0">Balance Sheet</h1>
        <a class="btn btn-outline-secondary" target="_blank" rel="noopener" href="{% url 'program_student_balance_print' program.id student.id %}">Printable Version</a>
      </div>
      <p class="mb-1"><span class="fw-semibold">Program:</span> {{ program.name }}</p>
      <p class="mb-3"><span class="fw-semibold">Student:</span> {{ student.first_name|default:student.legal_first_name }} {{ student.last_name }}</p>

      {% if entries %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th style="width: 120px;">Date</th>
                <th>Type</th>
                <th>Description</th>
                <th class="text-end" style="width: 160px;">Amount</th>
              </tr>
            </thead>
            <tbody>
              {% for e in entries %}
                <tr>
                  <td>{{ e.date }}</td>
                  <td>{{ e.type }}</td>
                  <td>
                    {% if e.type == 'Payment' and e.payment_id %}
                      <a href="{% url 'program_payment_detail' program.id e.payment_id %}">{{ e.name }}</a>
                    {% else %}
                      {{ e.name }}
                    {% endif %}
                  </td>
                  <td class="text-end">${{ e.amount|floatformat:2 }}</td>
                </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <th colspan="3" class="text-end">Total Fees</th>
                <th class="text-end">${{ total_fees|floatformat:2 }}</th>
              </tr>
              {% can_read user 'sliding_scale' as can_view_sliding %}
              {% if can_view_sliding %}
              <tr>
                <th colspan="3" class="text-end">Sliding Scale</th>
                <th class="text-end">-${{ total_sliding|floatformat:2 }}</th>
              </tr>
              {% endif %}
              <tr>
                <th colspan="3" class="text-end">Payments</th>
                <th class="text-end">-${{ total_payments|floatformat:2 }}</th>
              </tr>
              <tr>
                <th colspan="3" class="text-end">Final Balance</th>
                <th class="text-end">${{ balance|floatformat:2 }}</th>
              </tr>
            </tfoot>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info">No financial entries yet for this student and program.</div>
      {% endif %}

      <div class="card mt-4 border-info shadow-sm">
        <div class="card-body">
          <h5 class="card-title h6"><i class="bi bi-file-earmark-lock"></i> Secure Tax Form Upload</h5>
          <p class="card-text small text-muted">
            If you need to apply for a sliding scale discount, please upload a redacted copy of your most recent tax form (1040).
            Lead mentors will review the form and apply the appropriate discount to the student's account, then the file will be deleted.
          </p>
          <form method="post" action="{% url 'program_sliding_scale_parent_upload' program.id student.id %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="input-group">
              <input type="file" name="tax_form" class="form-control form-control-sm" id="tax_form_input" multiple required>
              <button class="btn btn-sm btn-info text-white" type="submit">Upload & Notify Lead Mentors</button>
            </div>
          </form>
          {% if sliding_scale.tax_forms.exists %}
            <div class="mt-2 small text-success">
              <i class="bi bi-check-circle-fill"></i> {{ sliding_scale.tax_forms.count }} tax form(s) currently uploaded. A mentor will review them soon.
            </div>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
{% endblock %}
