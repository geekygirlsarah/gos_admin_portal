{% extends 'base.html' %}
{% block title %}Program: {{ program.name }}{% endblock %}
{% block nav_programs_active %} active{% endblock %}
{% block content %}
  <div class="row mb-3">
    <div class="col">
      <a class="link-secondary" href="/programs/">‚Üê Back to Programs</a>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-10 col-xl-8">
      <h1 class="h3">{{ program.name }}{% if program.year %} <small class="text-muted">({{ program.year }})</small>{% endif %}</h1>

      <p><span class="fw-semibold">Program Active:</span> <span class="badge {% if program.active %}bg-success{% else %}bg-secondary{% endif %}">{{ program.active|yesno:"Yes,No" }}</span></p>
      <p class="text-muted">{{ program.description|default:"No description provided." }}</p>
      <hr>
        <div class="mt-4 d-flex flex-wrap gap-2">
            <a class="btn btn-outline-dark" href="{% url 'program_email' program.id %}">Send Email</a>
            <a class="btn btn-outline-dark" href="{% url 'program_dues_owed' program.id %}">All Dues Owed</a>
            <a class="btn btn-outline-dark" href="{% url 'program_student_photos' program.id %}">Photo View</a>
        </div>
        <div><br/></div>

      <h2 class="h5">Students in this Program</h2>
      {% if active_students %}
        <ul class="list-group mb-4">
          {% for s in active_students %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                {% if s.photo %}
                  <img src="{{ s.photo.url }}" alt="{{ s.first_name|default:s.legal_first_name }} {{ s.last_name }}" style="width:32px;height:32px;object-fit:cover;border-radius:50%;margin-right:8px;vertical-align:middle;"/>
                {% endif %}
                {{ s.first_name|default:s.legal_first_name }} {{ s.last_name }}
              </div>
              <div class="d-flex gap-2">
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'program_student_balance' program.id s.id %}">Balance</a>
                {% if can_manage_students %}
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'student_edit' s.id %}?next={% url 'program_detail' program.id %}">Edit</a>
                  <form action="{% url 'program_student_remove' program.id s.id %}" method="post" class="m-0">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-danger" type="submit" onclick="return confirm('Remove {{ s.first_name|default:s.legal_first_name }} {{ s.last_name }} from {{ program.name }}?')">Remove</button>
                  </form>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="alert alert-info">No active students currently enrolled.</div>
      {% endif %}

      {% if inactive_students %}
        <h3 class="h6">Students No Longer Active</h3>
        <ul class="list-group mb-4">
          {% for s in inactive_students %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                {% if s.photo %}
                  <img src="{{ s.photo.url }}" alt="{{ s.first_name|default:s.legal_first_name }} {{ s.last_name }}" style="width:32px;height:32px;object-fit:cover;border-radius:50%;margin-right:8px;vertical-align:middle;"/>
                {% endif %}
                {{ s.first_name|default:s.legal_first_name }} {{ s.last_name }}
                <span class="badge bg-secondary ms-2">Inactive</span>
              </div>
              <div class="d-flex gap-2">
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'program_student_balance' program.id s.id %}">Balance</a>
                {% if can_manage_students %}
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'student_edit' s.id %}?next={% url 'program_detail' program.id %}">Edit</a>
                  <form action="{% url 'program_student_remove' program.id s.id %}" method="post" class="m-0">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-danger" type="submit" onclick="return confirm('Remove {{ s.first_name|default:s.legal_first_name }} {{ s.last_name }} from {{ program.name }}?')">Remove</button>
                  </form>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% endif %}

      {% if can_manage_students %}
        <div class="row g-4">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">Add Existing Student</div>
              <div class="card-body">
                <form method="post" action="{% url 'program_student_add' program.id %}">
                  {% csrf_token %}
                  <div class="mb-3">{{ add_existing_form.as_p }}</div>
                  <button class="btn btn-primary" type="submit">Add to Program</button>
                </form>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">Quickly Create New Student</div>
              <div class="card-body">
                <form method="post" action="{% url 'program_student_quick_create' program.id %}">
                  {% csrf_token %}
                  <div class="mb-3">{{ quick_create_form.as_p }}</div>
                  <button class="btn btn-success" type="submit">Create and Add</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      {% endif %}

      {% if can_manage_fees or can_add_payment or can_add_sliding_scale %}
      <div class="mt-4">
        <div class="card">
          <div class="card-header">Fees, Payments, and Sliding Scale</div>
          <div class="card-body d-flex flex-wrap gap-2">
            {% if can_manage_fees %}
              <a class="btn btn-outline-dark" href="{% url 'program_fee_select' program.id %}">Manage Fee Applicability</a>
            {% endif %}
            {% if can_add_payment %}
              <a class="btn btn-outline-secondary" href="{% url 'program_payment_create' program.id %}">Record a Payment</a>
            {% endif %}
            {% if can_add_sliding_scale %}
              <a class="btn btn-outline-primary" href="{% url 'program_sliding_scale_create' program.id %}">Add Sliding Scale</a>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  {% endblock %}