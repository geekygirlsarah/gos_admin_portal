{% extends 'base.html' %}
{% block title %}Messaging{% endblock %}
{% block extra_head %}
  <!-- Quill rich-text editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
{% endblock %}
{% block content %}
<div class="row mb-3">
  <div class="col">
    {% if program %}
      <a class="link-secondary" href="{% url 'program_detail' program.id %}">← Back to {{ program.name }}</a>
    {% else %}
      <a class="link-secondary" href="{% url 'program_list' %}">← Back to Programs</a>
    {% endif %}
  </div>
</div>
<div class="row">
  <div class="col-lg-10 col-xl-8">
    <h1 class="h4">Email Messaging{% if program %} — {{ program.name }}{% endif %}</h1>
    <div class="alert alert-info">Mentors are not linked to programs in the current data model; selecting Mentors will email all active mentors.</div>
    <form method="post">
      {% csrf_token %}
      {% if not program %}
        <div class="mb-3">{{ form.program.label_tag }} {{ form.program }}</div>
      {% else %}
        {{ form.program }}
      {% endif %}

      <div class="mb-3">
        {{ form.from_account.label_tag }} {{ form.from_account }}
        <div class="form-text">Choose which email address to send from.</div>
      </div>

      <div class="mb-3">
        <label class="form-label">Recipient groups</label>
        {{ form.recipient_groups }}
        <div class="form-text">Parents/guardians will only be emailed if they are opted in to receive email updates.</div>
      </div>
      <div class="mb-3">
        {{ form.subject.label_tag }} {{ form.subject }}
      </div>

      <!-- Rich text editor -->
      <div class="mb-3">
        <label class="form-label">Message body</label>
        <div id="editor" style="height: 300px;" class="form-control"></div>
        <input type="hidden" name="body" id="id_body">
        <div class="form-text">Rich text is supported. The email will be sent in HTML format with a plain-text fallback.</div>
      </div>

      <div class="mb-3">
        {{ form.test_email.label_tag }} {{ form.test_email }}
        <div class="form-text">Optional: If set, the message will be sent only to this address for testing.</div>
      </div>

      <button type="submit" class="btn btn-primary" onclick="beforeSubmit()">Send Email</button>
    </form>
  </div>
</div>
{% endblock %}
{% block extra_scripts %}
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script>
    var quill = new Quill('#editor', {
      theme: 'snow'
    });
    // Initialize with any previous content if validation failed
    {% if form.data.body %}
      quill.root.innerHTML = {{ form.data.body|safe|escapejs }};
    {% endif %}
    function beforeSubmit() {
      var html = quill.root.innerHTML;
      document.getElementById('id_body').value = html;
    }
  </script>
{% endblock %}
