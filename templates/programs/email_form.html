{% extends 'base.html' %}
{% block title %}Messaging{% endblock %}
{% block extra_head %}
  <!-- Quill rich-text editor + better-table plugin -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/quill-better-table@1.2.10/dist/quill-better-table.min.css">
  <style>
    #editor { height: 300px; }
  </style>
{% endblock %}
{% block content %}
<div class="row mb-3">
  <div class="col">
    {% if program %}
      <a class="link-secondary" href="{% url 'program_detail' program.id %}">← Back to {{ program.name }}</a>
    {% else %}
      <a class="link-secondary" href="{% url 'program_list' %}">← Back to Programs</a>
    {% endif %}
  </div>
</div>
<div class="row">
  <div class="col-lg-10 col-xl-8">
    <h1 class="h4">Email Messaging{% if program %} — {{ program.name }}{% endif %}</h1>
    <div class="alert alert-info">Mentors are not linked to programs in the current data model; selecting Mentors will email all active mentors.</div>
    <form method="post">
      {% csrf_token %}
      {% if not program %}
        <div class="mb-3">{{ form.program.label_tag }} {{ form.program }}</div>
      {% else %}
        {{ form.program }}
      {% endif %}
      <div class="mb-3">
        <label class="form-label">Recipient groups</label>
        {{ form.recipient_groups }}
        <div class="form-text">Parents/guardians will only be emailed if they are opted in to receive email updates.</div>
      </div>
      <div class="mb-3">
        {{ form.subject.label_tag }} {{ form.subject }}
      </div>

      <!-- Rich text editor -->
      <div class="mb-3">
        <label class="form-label">Message body</label>
        <div id="editor" style="height: 300px;" class="form-control"></div>
        <input type="hidden" name="body" id="id_body">
        <div class="form-text">Rich text is supported. The email will be sent in HTML format with a plain-text fallback.</div>
      </div>

      <div class="mb-3">
        {{ form.test_email.label_tag }} {{ form.test_email }}
        <div class="form-text">Optional: If set, the message will be sent only to this address for testing.</div>
      </div>

      <button type="submit" class="btn btn-primary" onclick="beforeSubmit()">Send Email</button>
    </form>
  </div>
</div>
{% endblock %}
{% block extra_scripts %}
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <script src="https://unpkg.com/quill-better-table@1.2.10/dist/quill-better-table.min.js"></script>
  <script>
    // Register better-table module
    Quill.register({ 'modules/better-table': quillBetterTable }, true);

    // Optional: whitelist fonts and sizes
    var Size = Quill.import('formats/size');
    Size.whitelist = ['small', false, 'large', 'huge'];
    Quill.register(Size, true);

    var Font = Quill.import('formats/font');
    Font.whitelist = ['sans-serif', 'serif', 'monospace'];
    Quill.register(Font, true);

    var toolbarOptions = [
      [{ 'font': Font.whitelist }],
      [{ 'size': Size.whitelist }],
      [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
      ['bold', 'italic', 'underline', 'strike'],
      [{ 'color': [] }, { 'background': [] }],
      [{ 'script': 'sub' }, { 'script': 'super' }],
      [{ 'align': [] }],
      [{ 'list': 'ordered' }, { 'list': 'bullet' }],
      ['blockquote', 'code-block'],
      ['link', 'image'],
      ['clean']
    ];

    var quill = new Quill('#editor', {
      theme: 'snow',
      modules: {
        toolbar: toolbarOptions,
        table: false, // disable Quill built-in table
        'better-table': {
          operationMenu: {
            items: {
              unmergeCells: { text: 'Unmerge Cells' },
            }
          }
        },
        keyboard: {
          bindings: quillBetterTable.keyboardBindings
        }
      }
    });

    // Add a minimal Insert Table button next to the editor label
    (function() {
      var label = document.querySelector('label.form-label[for="editor"]') || document.querySelector('label.form-label');
      // Create a small button row below the label
      var toolbarRow = document.createElement('div');
      toolbarRow.className = 'mb-2';
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-sm btn-outline-secondary';
      btn.textContent = 'Insert 3×3 Table';
      btn.addEventListener('click', function() {
        quill.getModule('better-table').insertTable(3, 3);
      });
      toolbarRow.appendChild(btn);
      var editorContainer = document.getElementById('editor');
      editorContainer.parentNode.insertBefore(toolbarRow, editorContainer);
    })();

    // Initialize with any previous content if validation failed
    {% if form.data.body %}
      quill.root.innerHTML = {{ form.data.body|safe|escapejs }};
    {% endif %}

    function beforeSubmit() {
      var html = quill.root.innerHTML;
      document.getElementById('id_body').value = html;
    }
    window.beforeSubmit = beforeSubmit;
  </script>
{% endblock %}
