{% extends 'base.html' %}
{% block title %}Messaging{% endblock %}
{% block extra_head %}
  {% load static %}
  <!-- Quill rich-text editor (self-hosted); provide CDN fallback via JS if unavailable -->
  <link href="{% static 'vendor/quill/1.3.7/quill.snow.css' %}" rel="stylesheet">
  <style>
    #editor { height: 300px; }
    /* Reset: remove custom recipient_groups styling to fall back to default browser/Bootstrap */
  </style>
{% endblock %}
{% block content %}
<div class="row mb-3">
  <div class="col">
    {% if program %}
      <a class="link-secondary" href="{% url 'program_detail' program.id %}">← Back to {{ program.name }}</a>
    {% else %}
      <a class="link-secondary" href="{% url 'program_list' %}">← Back to Programs</a>
    {% endif %}
  </div>
</div>
<div class="row">
  <div class="col-lg-10 col-xl-9">
    <h1 class="h4 mb-3">Email Messaging{% if program %} — {{ program.name }}{% endif %}</h1>

      {% if form.non_field_errors %}
          <div class="alert alert-danger">{{ form.non_field_errors }}</div>
      {% endif %}
      {% for field in form %}
          {% if field.errors %}
              <div class="text-danger small">{{ field.label }}: {{ field.errors|join:", " }}</div>
          {% endif %}
      {% endfor %}

{#    <div class="alert alert-info d-flex align-items-start" role="alert">#}
{#      <div>#}
{#        <div class="fw-semibold">Heads up</div>#}
{#        <small>Mentors are not linked to programs in the current data model; selecting Mentors will email all active mentors.</small>#}
{#      </div>#}
{#    </div>#}

    <form method="post" class="needs-validation" novalidate>
      {% csrf_token %}

      <!-- Audience -->
      <div class="card mb-3">
        <div class="card-header">Audience</div>
        <div class="card-body">
          {% if not program %}
            <div class="mb-3">
              {{ form.program.label_tag }}
              {{ form.program }}
              {% if form.program.help_text %}<div class="form-text">{{ form.program.help_text }}</div>{% endif %}
            </div>
          {% else %}
            {{ form.program }}
          {% endif %}

          <div class="mb-3">
            <label class="form-label">Recipient groups</label>

              {{ form.recipient_groups }}

            <div class="form-text">Parents/guardians will only be emailed if they are opted in to receive email updates.</div>
              <div class="form-text">Mentors are not linked to programs in the current data model; selecting Mentors will email all active mentors.</div>
          </div>
        </div>
      </div>

      <!-- Sender -->
      <div class="card mb-3">
        <div class="card-header">Sender</div>
        <div class="card-body">
          <div class="mb-0">
            {{ form.from_account.label_tag }}
            {{ form.from_account }}
            <div class="form-text">Choose the sender address.</div>
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="card mb-3">
        <div class="card-header">Content</div>
        <div class="card-body">
          <div class="mb-3">
            {{ form.subject.label_tag }}
            {{ form.subject }}
          </div>

          <div class="mb-0">
            <label class="form-label">Message body</label>
            <div id="editor" class="form-control"></div>
            <input type="hidden" name="body" id="id_body" value="{{ form.body.value|default:'' }}">
            <div class="form-text">Rich text is supported. The email will be sent in HTML format with a plain-text fallback.</div>
          </div>
        </div>
      </div>

      <!-- Testing & Send -->
      <div class="card mb-4">
        <div class="card-header">Testing &amp; Send</div>
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-6">
              {{ form.test_email.label_tag }}
              {{ form.test_email }}
              <div class="form-text">Optional: If set, the message will be sent only to this address for testing.</div>
            </div>
            <div class="col-md-6 text-md-end mt-3 mt-md-0">
              <button type="submit" class="btn btn-primary">Send Email</button>
            </div>
          </div>
        </div>
      </div>

    </form>
  </div>
</div>
{% endblock %}
{% block extra_scripts %}
    {% load static %}
    <script src="{% static 'vendor/quill/1.3.7/quill.min.js' %}"></script>
    <script nonce="{{ csp_nonce }}">
        // Fallback: if local Quill not found, load from CDN allowed by CSP
        (function() {
            if (!window.Quill) {
                var s = document.createElement('script');
                s.src = 'https://cdn.quilljs.com/1.3.7/quill.min.js';
                s.onload = initQuill;
                document.head.appendChild(s);
            } else {
                initQuill();
            }
            function initQuill() {
            var hiddenBody = document.getElementById('id_body');
            var editorEl = document.getElementById('editor');
            var quill = null;

            // Defensive: ensure Quill is present
            if (!window.Quill) {
                console.error('Quill library failed to load. Falling back to plain textarea.');
                // Minimal fallback: show a textarea if you want
                if (editorEl) {
                    var ta = document.createElement('textarea');
                    ta.className = 'form-control';
                    ta.rows = 12;
                    ta.value = hiddenBody && hiddenBody.value ? hiddenBody.value : '';
                    editorEl.replaceWith(ta);
                    // Keep hidden in sync on submit
                    var form = ta.form;
                    if (form) {
                        form.addEventListener('submit', function() {
                            if (hiddenBody) hiddenBody.value = ta.value;
                        }, { capture: true });
                    }
                }
                return;
            }

            // Try to register better-table; if it fails, continue without it
            var betterTableAvailable = false;
            try {
                if (typeof quillBetterTable !== 'undefined') {
                    Quill.register({ 'modules/better-table': quillBetterTable }, true);
                    betterTableAvailable = true;
                } else {
                    console.warn('quill-better-table not found; proceeding without table module.');
                }
            } catch (e) {
                console.warn('Failed to register quill-better-table; proceeding without it.', e);
                betterTableAvailable = false;
            }

            // Whitelist font/size (optional)
            try {
                var Size = Quill.import('formats/size');
                Size.whitelist = ['small', false, 'large', 'huge'];
                Quill.register(Size, true);
                var Font = Quill.import('formats/font');
                Font.whitelist = ['sans-serif', 'serif', 'monospace'];
                Quill.register(Font, true);
            } catch (e) {
                console.warn('Failed to register font/size whitelists.', e);
            }

            var toolbarOptions = [
                [{ 'font': ['sans-serif', 'serif', 'monospace'] }],
                [{ 'size': ['small', false, 'large', 'huge'] }],
                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'script': 'sub' }, { 'script': 'super' }],
                [{ 'align': [] }],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                ['blockquote', 'code-block'],
                ['link', 'image'],
                ['clean']
            ];

            // Build modules config with graceful fallback
            var modulesConfig = { toolbar: toolbarOptions };
            if (betterTableAvailable) {
                modulesConfig.table = false; // disable Quill built-in table
                modulesConfig['better-table'] = {
                    operationMenu: { items: { unmergeCells: { text: 'Unmerge Cells' } } }
                };
                modulesConfig.keyboard = { bindings: quillBetterTable.keyboardBindings };
            }

            try {
                quill = new Quill('#editor', { theme: 'snow', modules: modulesConfig });
            } catch (e) {
                console.error('Failed to initialize Quill. Falling back to plain textarea.', e);
                // Hard fallback to textarea
                var ta2 = document.createElement('textarea');
                ta2.className = 'form-control';
                ta2.rows = 12;
                ta2.value = hiddenBody && hiddenBody.value ? hiddenBody.value : '';
                editorEl.replaceWith(ta2);
                var form2 = ta2.form;
                if (form2) {
                    form2.addEventListener('submit', function() {
                        if (hiddenBody) hiddenBody.value = ta2.value;
                    }, { capture: true });
                }
                return;
            }

            // Insert a simple "Insert 3×3 Table" button if plugin is present
            if (betterTableAvailable) {
                try {
                    var toolbarRow = document.createElement('div');
                    toolbarRow.className = 'mb-2';
                    var btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn btn-sm btn-outline-secondary';
                    btn.textContent = 'Insert 3×3 Table';
                    btn.addEventListener('click', function() {
                        quill.getModule('better-table').insertTable(3, 3);
                    });
                    editorEl.parentNode.insertBefore(toolbarRow, editorEl);
                    toolbarRow.appendChild(btn);
                } catch (e) {
                    console.warn('Failed to add Insert Table button.', e);
                }
            }

            // Initialize from hidden input
            if (hiddenBody && hiddenBody.value) {
                quill.root.innerHTML = hiddenBody.value;
            }

            // Keep hidden body synchronized on content changes
            function syncBody() {
                var isTrulyEmpty = quill.getText().trim().length === 0;
                hiddenBody.value = isTrulyEmpty ? '' : quill.root.innerHTML;
            }
            quill.on('text-change', syncBody);

            // Sync on submit and prevent submit if still empty (optional)
            var form = hiddenBody.form;
            if (form) {
                form.addEventListener('submit', function() {
                    try { syncBody(); } catch (e) {}
                }, { capture: true });
            }

            // Expose for debugging
            window._quill = quill;
            }
        })();
    </script>
{% endblock %}
